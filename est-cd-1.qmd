# Estadística y ciencia de datos

El término "ciencia de datos" surgió recientemente, y hay discusión acerca de qué tan
apropiado es el término, si es correcto llamarla "ciencia", y en general, en cómo
definirla exactamente. En este curso tomamos el punto de vista de que:


- La ciencia de datos antes se llamaba análisis de datos. Esto quiere decir que
no ocurre en un espacio teórico o matemático, sino en aplicaciones específicas donde
buscamos tomar decisiones informadas. A su vez, algunas personas consideran
el análisis de datos como "estadística aplicada".
- La ciencia de datos, a diferencia del análisis de datos más tradicional,
reconoce y adopta ideas de desarrollo de software
e ingeniería que son relevantes para producir análisis y productos con buena
calidad y desempeño.

Desde este punto de vista, 
el estándar de validez más importante en la ciencia de datos (@tukeyda) es su 
funcionamiento en la práctica, y no la adherencia a argumentos teóricos, 
matemáticos o estadísticos.

Igualmente puede ser difícil definir qué es la estadística (algunos la ven como una
parte o rama de las matemáticas, en un extremo, y otros la consideran algo más cercano
al análisis de datos). En cualquier caso:

- La estadística puede considerarse como parte de la ciencia de datos. Sus resultados 
teóricos son guías y
nos dan bases para juzgar y pensar en procedimientos para contestar 
preguntas con datos (@tukeyda).




## Ejemplo: nacimientos

Comenzamos con un ejemplo de **análisis exploratorio**.
Consideremos una parte de los datos de nacimientos por día del INEGI de 1999 a 2016. Consideraremos sólo tres meses: enero a marzo de 2016. Estos datos, por su tamaño, pueden representarse de manera razonablemente efectiva en una visualización de serie de tiempo

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(lubridate)
library(kableExtra)
nacimientos <- read_rds("datos/nacimientos/natalidad.rds") |>
   ungroup() |> 
   filter(year(fecha) == 2016, month(fecha) <= 3)
```

Examinamos partes del contenido de la tabla:

```{r}
tab_1 <- nacimientos |> 
   select(fecha, n) |> 
   slice_head(n = 5)
tab_2 <- nacimientos |> 
   select(fecha, n) |> 
   slice_tail(n = 5)
kable(list(tab_1, tab_2)) |> kable_styling()
```

En un examen rápido de estos números no vemos nada fuera de orden. Los datos tienen forma de serie de tiempo regularmente espaciada (un dato para cada día). Podemos graficar de manera simple como sigue:

```{r, fig.width=9, fig.height = 2.5}
ggplot(nacimientos, aes(x = fecha, y = n)) +
   geom_point() +
   geom_line() + 
   scale_x_date(breaks = "1 week", date_labels = "%d-%b") 
```

Esta es una descripción de los datos, que quizá no es muy compacta pero muestra varios aspectos importantes. En este caso notamos algunos patrones que saltan a la vista. Podemos marcar los domingos de cada semana:

```{r, fig.width=9, fig.height = 2.5}
domingos_tbl <- nacimientos |> 
   filter(weekdays(fecha) == "Sunday")
ggplot(nacimientos, aes(x = fecha, y = n)) +
   geom_vline(aes(xintercept = fecha), domingos_tbl, colour = "salmon") +
   geom_point() +
   geom_line() + 
   scale_x_date(breaks = "1 week", date_labels = "%d-%b") 
```

Observamos que los domingos ocurren menos nacimientos y los sábados también ocurren relativamente menos nacimentos. ¿Por qué crees que sea esto?

Adicionalmente a estos patrones observamos otros aspectos interesantes:

-   El primero de enero hay considerablemente menos nacimientos de los que esperaríamos para un viernes. ¿Por qué?
-   El primero de marzo hay un exceso de nacimientos considerable. ¿Qué tiene de especial este primero de marzo?
-   ¿Cómo describirías lo que sucede en la semana que comienza el 21 de marzo? ¿Por qué crees que pase eso?
-   ¿Cuáles son los domingos con más nacimientos? ¿Qué tienen de especial y qué explicación puede tener?

La confirmación de estas hipótesis, dependiendo de su forma, puede ser relativamente simple (por ejemplo ver una serie más larga de domingos comparados con otros días de la semana) hasta muy compleja (investigar preferencias de madres, de doctores o de hospitales, costumbres y actitudes, procesos en el registro civil, etc.)

## Procesos generadores de datos {.unnumbered}

Nótese que en todas estas preguntas hemos tenido que recurrir a conocimientos generales y de dominio para interpretar y hacer hipótesis acerca de lo que vemos en la gráfica. Una visión descontextualizada no tiene mucha utilidad. Las explicaciones son típicamente complejas e intervienen distintos aspectos del comportamiento de actores, sistemas, y métodos de recolección de datos involucrados.

::: callout-note
# El proceso generador de datos

Al conjunto de esos aspectos que determinan los datos que finalmente observamos le llamamos el **proceso generador de datos**. Para datos que observamos "naturalmente" este proceso
generalmente es complicado.

:::

En la Ciencia de Datos buscamos entender las partes importantes del proceso generador

- La **descripición** correcta de los datos se logra con ese entendimiento de dominio y del proceso generador.
- La formulación y refinamiento de **preguntas** importantes y sus respuestas 
acerca de estos datos requiere entendimiento de dominio y del proceso generador.
- Más tarde, veremos que la inferencia estadística también depende de este entendimiento,
junto con propuestas del *diseño estadístico* que nos permite obtener los datos
necesarios para simplificar y dar certeza en el proceso de contestar las preguntas de interés.

Mucha parte de este trabajo no es estadístico, sino que es un esfuerzo
por entender el dominio (como sugiere el título de artículo de David A. Friedman: [Statistical Models and Shoe Leather](https://psychology.okstate.edu/faculty/jgrice/psyc5314/Freedman_1991A.pdf)).


## Ejemplo (cálculos renales) {.unnumbered}

Este es un estudio real acerca de tratamientos para cálculos renales (@kidney94). Pacientes se asignaron de una forma no controlada a dos tipos de tratamientos para reducir cálculos renales. Para cada paciente, conocemos el tipo de ćalculos que tenía (grandes o chicos) y si el tratamiento tuvo éxito o no.

La tabla original se ve como sigue (muestreamos algunos renglones):

```{r, message = FALSE}
calculos <- read_csv("./datos/kidney_stone_data.csv")
names(calculos) <- c("tratamiento", "tamaño", "éxito")
calculos <- calculos |> 
   mutate(tamaño = ifelse(tamaño == "large", "grandes", "chicos")) |> 
   mutate(resultado = ifelse(éxito == 1, "mejora", "sin_mejora")) |> 
   select(tratamiento, tamaño, resultado)
nrow(calculos)
calculos |> 
   sample_n(20) |> 
   kable()
```

Aunque estos datos contienen información de 700 pacientes (cada renglón es un paciente), los datos pueden resumirse sin pérdida de información contando como sigue:

```{r}
calculos_agregada <- calculos |> 
   group_by(tratamiento, tamaño, resultado) |> 
   count()
calculos_agregada |> kable()
```

Este resumen no es muy informativo, pero al menos vemos qué valores aparecen en cada columna de la tabla. Como en este caso nos interesa principalmente la tasa de éxito de cada tratamiento, podemos mejorar mostrando como sigue:

```{r}
calculos_agregada |> pivot_wider(names_from = resultado, values_from = n) |> 
   mutate(total = mejora + sin_mejora) |> 
   mutate(prop_mejora = round(mejora / total, 2)) |> 
   select(tratamiento, tamaño, total, prop_mejora) |> 
   arrange(tamaño) |> 
   kable()
```

Esta tabla descriptiva es una reescritura de los datos, y no hemos resumido nada todavía. Pero es apropiada para empezar a contestar la pregunta:

-   ¿Qué indican estos datos acerca de qué tratamiento es mejor? ¿Acerca del tamaño de cálculos grandes o chicos?

Supongamos que otro analista decide comparar los pacientes que recibieron cada tratamiento, ignorando la variable de tamaño:

```{r}
calculos |> group_by(tratamiento) |> 
   summarise(prop_mejora = mean(resultado == "mejora") |> round(2)) |> 
   kable()
```

y parece ser que el tratamiento $B$ es mejor que el $A$. Esta es una paradoja (un ejemplo de la [paradoja de Simpson](https://es.wikipedia.org/wiki/Paradoja_de_Simpson)) . Si un médico no sabe que tipo de cálculos tiene el paciente, ¿entonces debería recetar $B$? ¿Si sabe debería recetar $A$? Esta discusión parece no tener mucho sentido.

Podemos investigar por qué está pasando esto considerando la siguiente tabla, que solo examina cómo se asignó el tratamiento dependiendo del tipo de cálculos de cada paciente:

```{r}
calculos |> group_by(tratamiento, tamaño) |> count() |> 
   kable()
```

Nuestra hipótesis aquí es que la decisión de qué tratamiento usar depende del tamaño de los cálculos. En este caso, por alguna razón se prefiere utilizar el tratamiento $A$ para cálculos grandes, y $B$ para cálculos chicos. Esto quiere decir que en la tabla total *el tratamiento* $A$ está en desventaja porque se usa en casos más difíciles, pero el tratamiento $A$ parece ser en general mejor. 

- Una mejor respuesta a la pregunta
de qué tratamiento es mejor es la que presenta los datos desagregados
- La tabla desagregada de asignación del tratamiento nos informa acerca de cómo se está distribuyendo el tratamiento
en los pacientes.

Igual que en el ejemplo anterior, los resúmenes descriptivos están acompañados de hipótesis acerca del *proceso generador de datos*, y esto ilumina lo que estamos observando y nos guía hacia descripciones provechosas de los datos. Las explicaciones no son tan simples y, otra vez, interviene el comportamiento de doctores, tratamientos, y distintos tipos de padecimientos.

:::callout-tip
Describe qué tabla utilizarías para contestar la pregunta bajo el siguiente escenario: el tratamiento para enfermedad de corazón
se asigna a los pacientes, y unos días después se mide la presión
arterial, que puede ser alta (grandes) o baja (chicos). Sabemos
que parte del efecto del tratamiento se produce al bajar la presión
arterial de los pacientes.
:::


## Ejercicio: admisiones de Berkeley {.unnumbered}

Consideramos ahora los siguientes datos de admisión a distintos departamentos de Berkeley en 1975:

```{r}
data("UCBAdmissions")
adm_original <- UCBAdmissions |> as_tibble() |> 
   pivot_wider(names_from = Admit, values_from = n) 
adm_original |> knitr::kable()
```

Con algo de manipulación podemos ver tasas de admisión para *Male* y *Female*, y los totales de cada grupo que solicitaron en cada Departamento.

```{r}
adm_tbl <- adm_original |> 
   mutate(prop_adm = round(Admitted / (Admitted + Rejected), 2), total = Admitted + Rejected) |> 
   select(Gender, Dept, prop_adm, total) |> 
   pivot_wider(names_from = Gender, values_from = prop_adm:total)
adm_tbl |> knitr::kable()
```

Y complementamos con las tasas de aceptación a total por género, y tasas de aceptación por departamento:

```{r}
adm_original |> group_by(Gender) |> 
   summarise(Admitted = sum(Admitted), Rejected = sum(Rejected)) |> 
   mutate(prop_adm = round(Admitted / (Admitted + Rejected),2)) |> 
   kable()
```

```{r}
adm_original |> group_by(Dept) |> 
   summarise(Admitted = sum(Admitted), Rejected = sum(Rejected)) |> 
   mutate(prop_adm = round(Admitted / (Admitted + Rejected),2)) |> 
   kable()
```

-   ¿Qué observas acerca de las tasas de admisión en cada departamento, diferenciadas por género? ¿Qué tiene qué ver con el número de personas que solicitan en cada departamento?
-   Esta es una tabla *descriptiva*. Sin embargo, tiene que ser entendida en el contexto de los datos y su generación. ¿Qué hipótesis importantes sugieren estos datos? ¿Por qué hay tanta diferencia de género de solicitudes en algunos departamentos? ¿Por qué es sorprendente o no las variaciones en tasas de aceptación de estudiantes de cada género?
